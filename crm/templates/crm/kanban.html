<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–Ω–±–∞–Ω {{ project.name }}</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 5;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      padding: 12px 14px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }

    .topbar h1 {
      margin: 0;
      font-size: 1.25rem;
      line-height: 1.2;
    }

    .hint {
      margin: 4px 0 0;
      font-size: 0.92rem;
      color: #6b7280;
    }

    .topbar__right {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-top: 2px;
    }

    main {
      padding: 12px;
    }

    .board {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      overflow-x: auto;
      padding-bottom: 18px;
    }

    .column {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      width: 320px;
      flex: 0 0 320px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 120px);
    }

    .column__header {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .column__title {
      display: flex;
      align-items: baseline;
      gap: 8px;
      min-width: 0;
    }

    .column__title h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 205px;
    }

    .count {
      font-size: 0.85rem;
      color: #6b7280;
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      flex: 0 0 auto;
    }

    .cards {
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 64px;
    }

    .cards.drag-over {
      outline: 2px dashed #d1d5db;
      outline-offset: -6px;
      border-radius: 12px;
    }

    .card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 10px 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      cursor: grab;
      user-select: none;
    }

    .card:active { cursor: grabbing; }

    .card.dragging {
      opacity: 0.55;
    }

    .card__title {
      font-weight: 700;
      margin: 0 0 6px;
      overflow-wrap: anywhere;
    }

    .card__desc {
      white-space: pre-wrap;
      font-size: 0.92rem;
      color: #374151;
      overflow-wrap: anywhere;
    }

    .card__actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 8px;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 4px 6px;
      cursor: pointer;
      line-height: 1;
    }

    .icon-btn:hover {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .btn {
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font: inherit;
    }

    .btn:hover { background: #f9fafb; }

    .btn--small {
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .btn--primary {
      border-color: #1d4ed8;
    }
    .btn--primary:hover {
      background: #eef2ff;
    }

    .btn--danger {
      border-color: #b91c1c;
      color: #b91c1c;
    }
    .btn--danger:hover {
      background: #fef2f2;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }

    .modal.hidden { display: none; }

    .modal__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.45);
    }

    .modal__content {
      position: relative;
      background: #ffffff;
      width: min(520px, 100%);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      border: 1px solid #e5e7eb;
    }

    .modal__content h2 {
      margin: 0 0 12px;
      font-size: 1.1rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .field label {
      font-size: 0.92rem;
      color: #374151;
    }

    .field input, .field textarea, .field select {
      font: inherit;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
    }

    .field input:focus, .field textarea:focus, .field select:focus {
      outline: 2px solid #93c5fd;
      outline-offset: 2px;
    }

    .error {
      min-height: 1.2em;
      color: #b91c1c;
      font-size: 0.92rem;
      margin-top: -4px;
    }

    .modal__actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    @media (max-width: 520px) {
      .column {
        width: 290px;
        flex-basis: 290px;
      }
      .column__title h2 { max-width: 170px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar__left">
      <h1>–ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞ - {{ project.name }}</h1>
      <p class="hint">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ (–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏). –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å.</p>
    </div>
    <div class="topbar__right">
      <button id="clear-board" class="btn btn--danger" type="button" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
  </header>

  <main>
  <div
    id="board"
    class="board"
    aria-label="–ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞"
    data-project-id="{{ project.id }}"
  ></div>
  </main>


  <!-- Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal__backdrop" data-action="closeModal"></div>
    <div class="modal__content">
      <h2 id="modal-title">–ö–∞—Ä—Ç–æ—á–∫–∞</h2>

      <form id="card-form" novalidate>
        <div class="field">
          <label for="card-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
          <input id="card-title" name="title" type="text" maxlength="80" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É" />
        </div>

        <div class="field">
          <label for="card-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="card-description" name="description" rows="4" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏..."></textarea>
        </div>

        <div class="field">
          <label for="card-status">–≠—Ç–∞–ø</label>
          <select id="card-status" name="status"></select>
        </div>

        <div id="form-error" class="error" role="alert" aria-live="polite"></div>

        <div class="modal__actions">
          <button class="btn" type="button" data-action="closeModal">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn--primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
(() => {
  'use strict';

  // ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ (UI) ======
  // –≠—Ç–∏ —Å—Ç–∞—Ç—É—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ —É —Ç–µ–±—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ).
  const STATUSES = [
    { id: 'queue',      label: '–Ω–∞ –æ—á–µ—Ä–µ–¥–∏' },
    { id: 'inprogress', label: '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ' },
    { id: 'help',       label: '–Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∑–∞–¥–∞—á–µ–π' },
    { id: 'blocked',    label: '–ø–æ–¥–≤–∏—Å–ª–æ –∏–∑-–∑–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞' },
    { id: 'done',       label: '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ' },
  ];

  // ====== DOM ======
  const boardEl = document.getElementById('board');
  const clearBtn = document.getElementById('clear-board');

  const modalEl = document.getElementById('modal');
  const formEl = document.getElementById('card-form');
  const modalTitleEl = document.getElementById('modal-title');
  const titleInput = /** @type {HTMLInputElement} */ (formEl.elements.namedItem('title'));
  const descInput = /** @type {HTMLTextAreaElement} */ (formEl.elements.namedItem('description'));
  const statusSelect = /** @type {HTMLSelectElement} */ (formEl.elements.namedItem('status'));
  const errorEl = document.getElementById('form-error');

  // project_id –±–µ—Ä—ë–º –∏–∑ data-project-id="{{ project.id }}" –Ω–∞ #board
  const projectId = boardEl?.dataset.projectId;
  if (!projectId) {
    console.error('No projectId found on #board (data-project-id).');
    return;
  }

  // ====== API URLs ======
  const API_TASK_DELETE_URL = (taskId) => `/api/kanban/task/${taskId}/delete/`;
  const API_STATE_URL = `/api/kanban/${projectId}/`;
  const API_TASK_CREATE_URL = `/api/kanban/task/`;
  const API_TASK_URL = (taskId) => `/api/kanban/task/${taskId}/`;
  const API_REORDER_URL = `/api/kanban/reorder/`;

  // ====== State (—Ç–µ–ø–µ—Ä—å –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî —Å–µ—Ä–≤–µ—Ä) ======
  let state = defaultState(); // –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ—Ä–∂–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞
  let modalCtx = { mode: 'create', cardId: null };
  let pollingTimer = null;

  document.addEventListener('DOMContentLoaded', init);

  function init() {
    buildBoardSkeleton();
    populateStatusSelect();
    attachEvents();

    // –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ + polling (real-time)
    loadKanbanFromServer();
    pollingTimer = setInterval(loadKanbanFromServer, 3000);
  }

  function attachEvents() {
    boardEl.addEventListener('click', onBoardClick);
    boardEl.addEventListener('dblclick', onBoardDblClick);

    boardEl.addEventListener('dragstart', onDragStart);
    boardEl.addEventListener('dragend', onDragEnd);

    document.querySelectorAll('.cards').forEach((container) => {
      container.addEventListener('dragover', onDragOverCards);
    });

    modalEl.addEventListener('click', onModalClick);
    formEl.addEventListener('submit', onFormSubmit);
    document.addEventListener('keydown', onKeyDown);

    // "–°–±—Ä–æ—Å–∏—Ç—å –¥–æ—Å–∫—É" ‚Äî —ç—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞ (—á–µ—Ä–µ–∑ API).
    // –ï—Å–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –Ω–µ—Ç ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É.
    clearBtn.addEventListener('click', async () => {
      const ok = confirm('–°–±—Ä–æ—Å–∏—Ç—å –¥–æ—Å–∫—É? –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.');
      if (!ok) return;

      // –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ –æ–¥–Ω–æ–π
      // (–Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–∞).
      const ids = Object.keys(state.cards);
      for (const id of ids) {
        await apiDeleteTask(id);
      }
      await loadKanbanFromServer();
    });
  }

  // ====== UI Skeleton ======
  function buildBoardSkeleton() {
    const html = STATUSES.map(s => `
      <section class="column" data-status="${s.id}">
        <header class="column__header">
          <div class="column__title">
            <h2>${escapeHtml(s.label)}</h2>
            <span class="count" data-count="${s.id}">0</span>
          </div>
          <button class="btn btn--small" type="button" data-action="add" data-status="${s.id}">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </header>
        <div class="cards" data-status="${s.id}" aria-label="–ö–æ–ª–æ–Ω–∫–∞: ${escapeHtml(s.label)}"></div>
      </section>
    `).join('');
    boardEl.innerHTML = html;
  }

  function populateStatusSelect() {
    statusSelect.innerHTML = STATUSES
      .map(s => `<option value="${s.id}">${escapeHtml(s.label)}</option>`)
      .join('');
  }

  // ====== Click handlers ======
  function onBoardClick(e) {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;

    if (action === 'add') {
      const status = btn.dataset.status || 'queue';
      openModalCreate(status);
      return;
    }

    const cardEl = e.target.closest('.card');
    if (!cardEl) return;
    const cardId = cardEl.dataset.id;

    if (action === 'edit') {
      openModalEdit(cardId);
      return;
    }

    if (action === 'delete') {
      deleteCard(cardId);
      return;
    }
  }

  function onBoardDblClick(e) {
    const cardEl = e.target.closest('.card');
    if (!cardEl) return;
    openModalEdit(cardEl.dataset.id);
  }

  // ====== Modal ======
  function openModalCreate(status) {
    modalCtx = { mode: 'create', cardId: null };
    modalTitleEl.textContent = '–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞';
    errorEl.textContent = '';

    formEl.reset();
    statusSelect.value = status;

    showModal();
  }

  function openModalEdit(cardId) {
    const card = state.cards[cardId];
    if (!card) return;

    modalCtx = { mode: 'edit', cardId };
    modalTitleEl.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
    errorEl.textContent = '';

    titleInput.value = card.title || '';
    descInput.value = card.description || '';
    statusSelect.value = card.status || 'queue';

    showModal();
  }

  function showModal() {
    modalEl.classList.remove('hidden');
    modalEl.setAttribute('aria-hidden', 'false');
    setTimeout(() => titleInput.focus(), 0);
  }

  function closeModal() {
    modalEl.classList.add('hidden');
    modalEl.setAttribute('aria-hidden', 'true');
    errorEl.textContent = '';
    formEl.reset();
  }

  function onModalClick(e) {
    const close = e.target.closest('[data-action="closeModal"]');
    if (close) closeModal();
  }

  function onKeyDown(e) {
    if (e.key === 'Escape' && !modalEl.classList.contains('hidden')) {
      closeModal();
    }
  }

  // ====== Form submit ======
  async function onFormSubmit(e) {
    e.preventDefault();

    const title = titleInput.value.trim();
    const description = descInput.value.trim();
    const status = statusSelect.value;

    if (!title) {
      errorEl.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫.';
      titleInput.focus();
      return;
    }
    if (!isValidStatus(status)) {
      errorEl.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —ç—Ç–∞–ø.';
      return;
    }

    try {
      if (modalCtx.mode === 'create') {
        await apiCreateTask({ title, description, status });
        closeModal();
        await loadKanbanFromServer();
        return;
      }

      if (modalCtx.mode === 'edit' && modalCtx.cardId) {
        await apiPatchTask(modalCtx.cardId, { title, description, status });
        closeModal();
        await loadKanbanFromServer();
      }
    } catch (err) {
      console.error(err);
      errorEl.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
    }
  }

  // ====== CRUD (—á–µ—Ä–µ–∑ API) ======
  async function createCardLocal({ id, title, description, status }) {
    // –ª–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ UI (–µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å optimistic)
    state.cards[id] = { id, title, description, status, createdAt: Date.now(), updatedAt: Date.now() };
    state.order[status].unshift(id);
    renderAllColumns();
  }

  async function deleteCard(cardId) {
    const ok = confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?');
    if (!ok) return;

    try {
      await apiDeleteTask(cardId);
      await loadKanbanFromServer();
    } catch (err) {
      console.error(err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É.');
    }
  }

  // ====== Render ======
  function renderAllColumns() {
    STATUSES.forEach(s => {
      const container = document.querySelector(`.cards[data-status="${s.id}"]`);
      const countEl = document.querySelector(`[data-count="${s.id}"]`);
      if (!container) return;

      container.innerHTML = '';

      const ids = state.order[s.id] || [];
      ids.forEach((id) => {
        const card = state.cards[id];
        if (!card) return;
        container.appendChild(renderCard(card));
      });

      if (countEl) countEl.textContent = String(ids.length);
    });
  }

  function renderCountsOnly() {
    STATUSES.forEach(({ id }) => {
      const countEl = document.querySelector(`[data-count="${id}"]`);
      if (countEl) countEl.textContent = String((state.order[id] || []).length);
    });
  }

  function renderCard(card) {
    const el = document.createElement('article');
    el.className = 'card';
    el.setAttribute('draggable', 'true');
    el.dataset.id = String(card.id);

    const title = document.createElement('div');
    title.className = 'card__title';
    title.textContent = card.title;
    el.appendChild(title);

    if (card.description) {
      const desc = document.createElement('div');
      desc.className = 'card__desc';
      desc.textContent = card.description;
      el.appendChild(desc);
    }

    const actions = document.createElement('div');
    actions.className = 'card__actions';

    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.className = 'icon-btn';
    editBtn.dataset.action = 'edit';
    editBtn.setAttribute('aria-label', '–ò–∑–º–µ–Ω–∏—Ç—å');
    editBtn.title = '–ò–∑–º–µ–Ω–∏—Ç—å';
    editBtn.textContent = '‚úèÔ∏è';

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'icon-btn';
    delBtn.dataset.action = 'delete';
    delBtn.setAttribute('aria-label', '–£–¥–∞–ª–∏—Ç—å');
    delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
    delBtn.textContent = 'üóëÔ∏è';

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    el.appendChild(actions);

    return el;
  }

  /* -------------------- Drag & Drop -------------------- */

  function onDragStart(e) {
    const cardEl = e.target.closest('.card');
    if (!cardEl) return;

    cardEl.classList.add('dragging');

    if (e.dataTransfer) {
      e.dataTransfer.setData('text/plain', cardEl.dataset.id || '');
      e.dataTransfer.effectAllowed = 'move';
    }
  }

  async function onDragEnd() {
    const dragging = document.querySelector('.card.dragging');
    if (dragging) dragging.classList.remove('dragging');

    document.querySelectorAll('.cards.drag-over').forEach(el => el.classList.remove('drag-over'));

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π state –∏–∑ DOM (–¥–ª—è UI)
    syncStateFromDOM();
    renderCountsOnly();

    // –ò –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –º–∞—Å—Å–æ–≤–æ –ø–æ—Ä—è–¥–æ–∫
    try {
      await apiReorderFromState();
    } catch (err) {
      console.error(err);
      // –µ—Å–ª–∏ —É–ø–∞–ª–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞
      await loadKanbanFromServer();
    }
  }

  function onDragOverCards(e) {
    e.preventDefault();

    const container = e.currentTarget;
    if (!(container instanceof HTMLElement)) return;

    container.classList.add('drag-over');

    const dragging = document.querySelector('.card.dragging');
    if (!dragging) return;

    const afterElement = getDragAfterElement(container, e.clientY);
    if (afterElement == null) {
      container.appendChild(dragging);
    } else {
      container.insertBefore(dragging, afterElement);
    }
  }

  function getDragAfterElement(container, y) {
    const draggableElements = Array.from(container.querySelectorAll('.card:not(.dragging)'));

    let closestOffset = Number.NEGATIVE_INFINITY;
    let closestElement = null;

    draggableElements.forEach((child) => {
      const box = child.getBoundingClientRect();
      const offset = y - (box.top + box.height / 2);
      if (offset < 0 && offset > closestOffset) {
        closestOffset = offset;
        closestElement = child;
      }
    });

    return closestElement;
  }

  function syncStateFromDOM() {
    const newOrder = {};
    const seen = new Set();

    STATUSES.forEach(({ id: statusId }) => {
      const container = document.querySelector(`.cards[data-status="${statusId}"]`);
      if (!container) return;

      const ids = Array.from(container.querySelectorAll('.card'))
        .map(el => el.dataset.id)
        .filter(Boolean);

      const unique = [];
      ids.forEach((cid) => {
        if (seen.has(cid)) return;
        if (!state.cards[cid]) return;
        seen.add(cid);
        unique.push(cid);
      });

      newOrder[statusId] = unique;
      unique.forEach((cid) => { state.cards[cid].status = statusId; });
    });

    const orderedIds = new Set();
    Object.keys(newOrder).forEach((st) => {
      (newOrder[st] || []).forEach((cid) => orderedIds.add(cid));
    });

    Object.keys(state.cards).forEach((cid) => {
      if (orderedIds.has(cid)) return;
      state.cards[cid].status = 'queue';
      if (!newOrder.queue) newOrder.queue = [];
      newOrder.queue.push(cid);
    });

    state.order = Object.assign(defaultState().order, newOrder);
  }

  /* -------------------- Server (API) -------------------- */

  async function loadKanbanFromServer() {
    const resp = await fetch(API_STATE_URL, { credentials: 'same-origin' });
    if (!resp.ok) return;

    const data = await resp.json();

    // –û–∂–∏–¥–∞–µ–º:
    // data.columns: [{id, code/status, title, order}, ...] (–º–æ–∂–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)
    // data.tasks:   [{id, title, description, status, order}, ...]
    // –í–ê–ñ–ù–û: status –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑ STATUSES.id
    const next = defaultState();

    // tasks —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ status+order
    const tasks = Array.isArray(data.tasks) ? data.tasks.slice() : [];
    tasks.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

    for (const t of tasks) {
      const id = String(t.id);
      const status = isValidStatus(t.status) ? t.status : 'queue';

      next.cards[id] = {
        id,
        title: t.title || '',
        description: t.description || '',
        status,
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };
      next.order[status].push(id);
    }

    // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏—Å–ª–∞–ª order –¥–ª—è –ø—É—Å—Ç—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ ‚Äî –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å
    state = next;
    renderAllColumns();
  }

  async function apiCreateTask({ title, description, status }) {
    return fetchJson(API_TASK_CREATE_URL, {
      method: 'POST',
      body: JSON.stringify({ project: Number(projectId), title, description, status, order: 0 }),
    });
  }

  async function apiPatchTask(taskId, payload) {
    return fetchJson(API_TASK_URL(taskId), {
      method: 'PATCH',
      body: JSON.stringify(payload),
    });
  }

  async function apiDeleteTask(taskId) {
  const resp = await fetch(API_TASK_DELETE_URL(taskId), {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
    },
    credentials: 'same-origin',
  });
  if (!resp.ok) throw new Error('DELETE failed');
}


  async function apiReorderFromState() {
    // –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π: [{id, status, order}, ...]
    const updates = [];
    STATUSES.forEach(({ id: st }) => {
      const ids = state.order[st] || [];
      ids.forEach((taskId, idx) => {
        updates.push({ id: Number(taskId), status: st, order: idx });
      });
    });

    return fetchJson(API_REORDER_URL, {
      method: 'POST',
      body: JSON.stringify({ project: Number(projectId), updates }),
    });
  }

  async function fetchJson(url, { method, body }) {
    const resp = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      credentials: 'same-origin',
      body,
    });
    if (!resp.ok) throw new Error(`${method} ${url} failed`);
    return resp.json().catch(() => ({}));
  }

  /* -------------------- Storage-free default state -------------------- */

  function defaultState() {
    const order = {};
    STATUSES.forEach(s => { order[s.id] = []; });
    return { cards: {}, order };
  }

  /* -------------------- Helpers -------------------- */

  function isValidStatus(status) {
    return STATUSES.some(s => s.id === status);
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }
})();
</script>

</body>
</html>
